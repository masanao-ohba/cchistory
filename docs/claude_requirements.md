# Claude Conversations History Viewer - 開発要件書

## 開発環境要件

### HMR（Hot Module Replacement）
**必須**: 開発効率のため有効化を維持
**理由**: ファイル変更の即時反映、Vue状態保持
**制約**: ngrok対応必須、Dockerコンテナ環境考慮
**解決**:
- HMRをViteサーバーと同じポート（3000）で実行（Docker環境での簡素化）
- クライアント接続先を動的に設定（localhost/ngrok自動判定）

## 新着メッセージ表示機能

### グループ定義
**メッセージグループ**: ユーザー発言から次のユーザー発言までの一連のメッセージ
- 構成: 1つのユーザー発言 + それに続く複数のアシスタント応答
- 区切り: 次のユーザー発言が来た時点で新しいグループ開始

### 基本仕様
- 初回ロード時: 全メッセージ即座表示
- WebSocket更新時（新着メッセージ受信時）:
  - ユーザーメッセージ: 即時表示
  - **新着**アシスタントメッセージのうち**同一グループ内**1個目: 即時表示
  - **新着**アシスタントメッセージのうち**同一グループ内**2個目以降: 「新着メッセージ表示」ボタン経由

### 重要な判定基準
**「新着」の定義**: 初期ロード時には存在せず、WebSocket等で後から追加されたメッセージのみ
- 既存のアシスタントメッセージが複数あっても、それらは初期表示済みなので対象外
- 新着メッセージ表示ボタンは「初期状態にはなかった新着メッセージ」にのみ適用

### 実装方針
- 既存の即時表示機能を保持
- 最小限の変更で機能追加
- リアクティビティ問題を避ける設計

### テスト要件
**新着メッセージ機能のテスト**: `useNewMessageManager.test.js`
- UUID識別による確実な新着判定
- グループ毎の独立した管理
- 既存メッセージの誤判定防止
- 複数回の段階的新着追加

**テスト実行コマンド:**
```bash
# 新着メッセージ機能テスト
npm test --prefix frontend -- useNewMessageManager

# 全テスト実行
npm test --prefix frontend

# 監視モード（開発時推奨）
npm run test:watch --prefix frontend
```

## 開発原則

### 安定性優先
1. **既存機能を壊さない**: 新機能追加前に現状動作確認
2. **最小限変更**: 必要最小限のコード変更
3. **段階的実装**: 機能を分割し、各段階でテスト

### コード品質
- 不要なconsole.log/warnは削除
- 型安全性を確保（Vue props等）
- エラーハンドリングを適切に実装

## 技術的制約

### Vue.js
- プロップスとして関数渡しは避ける（リアクティビティ問題）
- emit/eventベースの通信を推奨

### データ整合性
**目的**: フロントエンドでの型エラーや実行時エラーを防ぎ、安定した動作を保証する
- 一貫したデータ型により、条件分岐や型チェックを最小化
- 予期しないデータ型(null/undefined等含む)によるアプリケーションクラッシュを防止

### Docker環境
- ホスト名設定は`0.0.0.0`維持（ngrok対応）
- ポート競合に注意（アプリ: 18080, Vite/HMR: 3000）
- HMRはViteサーバーと同じポートを使用（Docker環境での簡素化）

## 判断基準

### 修正・実装前チェックリスト
- [ ] 現在の動作は正常か？
- [ ] この変更で既存機能は影響受けないか？
- [ ] より小さな変更で実現可能か？
- [ ] エラーハンドリングは適切か？
- [ ] 開発効率は維持されるか？
